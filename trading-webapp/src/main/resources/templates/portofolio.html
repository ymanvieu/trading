<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title th:utext="#{portofolio.name}"></title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/@bootstrap.version@/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/@datatables.version@/css/dataTables.bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/@bootstrap-touchspin.version@/jquery.bootstrap-touchspin.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/@datatables-responsive.version@/css/responsive.dataTables.min.css" />
<link rel="stylesheet" href="/css/style.css" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>		
	<div th:replace="fragments/header-footer :: header"></div>
	<div th:replace="fragments/header-footer :: footer"></div>
	
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/datatables/@datatables.version@/js/jquery.dataTables.min.js" ></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/datatables/@datatables.version@/js/dataTables.bootstrap.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/responsive/@datatables-responsive.version@/js/dataTables.responsive.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/@bootstrap-touchspin.version@/jquery.bootstrap-touchspin.min.js"></script>
	
	<div class="container">
	
		<div th:replace="fragments/msg :: msg(response=${response})"></div>
		
		
		<table id="portofolioTable" class="table table-striped table-hover">
			<thead>
				<tr>
					<th data-priority="1">Code</th>
					<th data-priority="8">Currency</th>
					<th data-priority="7">Quantity</th>
					<th data-priority="4" class="nowrap">Current value</th>
					<th data-priority="6" class="nowrap">Current rate</th>
					<th data-priority="3" class="nowrap">% change</th>
					<th data-priority="5" class="nowrap">Value change</th>
					<th data-priority="2"></th>
				</tr>
			</thead>
			<tfoot>
				<tr th:object="${portofolio}" style="font-weight: bold;">
				    <td>Total</td>
				    <td>
				    	<span th:inline="text">
							<img class="m-align" th:if="*{baseCurrency.symbol.countryFlag}" th:src="'/img/flag/'+*{baseCurrency.symbol.countryFlag}+'.gif'" />
							<span class="m-align">[[*{baseCurrency.symbol.name}]]</span>
						</span>	
				    </td>
				    <td></td>
				    <td th:text="${{portofolio.currentValue}}"></td>
				    <td></td>
				 	<td class="colored" th:inline="text">
						[[*{percentChange eq 0} ? '0' : *{{percentChange}}]]
				 	</td>
				    <td class="colored" th:inline="text">
						[[*{valueChange eq 0} ? '0' : *{{valueChange}}]]
				 	</td>
				 	<td>
				 		<button type="button" th:disabled="${#lists.isEmpty(availableSymbols)}" class="btn btn-success" data-toggle="modal" data-type="BUY" data-code="" data-target="#myModal">Buy new asset</button>	
				 	</td>
				  </tr>
  			</tfoot>
			<tbody th:object="${portofolio}">
				<tr th:each="a : *{assets}">
					<td> 
						<span th:inline="text">
							<img class="m-align" th:if="${a.symbol.countryFlag}" th:src="@{/img/flag/}+${a.symbol.countryFlag}+'.gif'" />
							<span class="m-align"><a>[[${a.symbol.name}]]<span class="hidden-xs hidden-sm"> ([[${a.symbol.code}]])</span></a></span>
						</span>					
					</td>
					<td>
						<span th:inline="text" th:object="${a.currency}">
							<img class="m-align" th:src="@{/img/flag/}+*{countryFlag}+'.gif'" />
							<span class="hidden-xs hidden-sm m-align">[[*{name}]]</span>
							<span class="hidden-md hidden-lg m-align">[[*{code}]]</span>
						</span>
					</td>
					<td th:text="${{a.quantity}}"></td>
					<td th:text="${{a.currentValue}}"></td>
					<td th:text="${{a.currentRate}}"></td>
					<td class="colored" th:text="${{a.percentChange}} eq 0 ? '0' : ${{a.percentChange}}"></td>
					<td class="colored" th:text="${{a.valueChange}} eq 0 ? '0' : ${{a.valueChange}}"></td>
					<td>
						<div class = "btn-group-inline">
							<button type="button" class="btn btn-success" data-toggle="modal" data-type="BUY" th:attr="data-code=${a.symbol.code}" data-target="#myModal" th:utext="#{order.buy}"></button>
							<button type="button" class="btn btn-danger" data-toggle="modal" data-type="SELL" th:attr="data-code=${a.symbol.code}" data-target="#myModal" th:utext="#{order.sell}"></button>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>	
	
	<!-- Modal -->
	<div class="modal fade" id="myModal">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="modal-title"></h4>
				</div>
				
				<form th:object="${orderInfo}" method="post" action="#" th:action="@{/portofolio}">
					
					<div class="modal-body">
					
						<input type="hidden" name="code"/>
						<input type="hidden" name="type"/>
						<input type="hidden" name="isOwned"/>
	
						<input oninput="getData()" onchange="getData()" autocomplete="off" type="text" name="quantity" class="form-control"/> 
	
						<p></p>
	
						<div id="result" th:fragment="result" class="row">
							<div class="col-md-6 col-md-offset-3">
							
								<select id="selectectedSymbol" class="form-control" name="codeSelected" onchange="getData()">
									<option th:each="s : ${availableSymbols}" 
									th:selected="${orderInfo} ? (${orderInfo.selected.symbol.code} == ${s.code}) : (${availableSymbols[0].code} == ${s.code})" 
									onselect="getData()" th:value="${s.code}" th:text="|${s.name} (${s.code})|"></option>
								</select>
				
								<table class="table table-striped table-hover" th:if="${orderInfo}" th:object="${orderInfo.selected}">
									<tbody>
										<tr th:if="*{quantity}">
											<td>Owned</td>
											<td th:text="*{{quantity}}"></td>
										</tr>
										<tr th:if="*{value}">
											<td>Invested value</td>
											<td th:text="*{{value}}"></td>
										</tr>
										<tr th:if="*{currentValue}">
											<td>Current value</td>
											<td th:text="*{{currentValue}}"></td>
										</tr>
										<tr th:if="*{currentRate}">
											<td>Current rate</td>
											<td th:text="*{{currentRate}}"></td>
										</tr>
										<tr th:if="*{percentChange}">
											<td>% change</td>
											<td class="colored" th:text="*{{percentChange}} eq 0 ? '0' : *{{percentChange}}"></td>
										</tr>
										<tr th:if="*{valueChange}">
											<td>Value change</td>
											<td class="colored"
												th:text="(*{{valueChange}} eq 0 ? '0' : *{{valueChange}})+' '+ (${orderInfo.selectedCurrency} ? ${orderInfo.selectedCurrency.symbol.code} : '')"></td>
										</tr>
										<tr th:if="${orderInfo.selectedCurrency}" th:object="${orderInfo.selectedCurrency}">
											<td>Currency available</td>
											<td><span th:text="*{quantity} eq 0 ? '0' : *{{quantity}}+' '+*{symbol.code}"></span></td>
										</tr>
										<tr th:if="${orderInfo.gainCost} and ${orderInfo.selectedCurrency}">
											<td>Gain/Cost</td>
											<td class="colored" th:text="(${{orderInfo.gainCost}} eq 0 ? '0' : ${{orderInfo.gainCost}})"></td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<input class="btn" id="submitBtn" type="submit" value="" /> 
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<script type="text/javascript" th:inline="javascript">			
		$(function() { 
			$("#portofolioTable").DataTable({
	            columnDefs: [
	            	{type: 'formatted-num', targets: [2,3,4,5,6]},
	            	{"orderable": false, "targets": 7}
                ],
                responsive: {
                	details: {
                        type: 'column'
                    }	                	
                },
	        	"autoWidth": false
	        });
		 }); 
		
		jQuery.extend( jQuery.fn.dataTableExt.oSort, {
		    "formatted-num-pre": function ( a ) {
		        a = (a === "-" || a === "") ? 0 : a.replace( /[^\d\-\.\,]/g, "").replace( /,/, "." );
		        return parseFloat( a );
		    },
		    "formatted-num-asc": function ( a, b ) {
		        return a - b;
		    },
		    "formatted-num-desc": function ( a, b ) {
		        return b - a;
		    }
		} );
		
		// <![CDATA[
		function getData() {
			
			var inputCode = $('input[name="code"]');
			var selectCode = $('select[name="codeSelected"]').find(":selected");
			
			var isSelectCode = $('input[name="isOwned"]').val() == 'false';
			
			var code = isSelectCode ?  selectCode.val() : inputCode.val();
			
			inputCode.val(code);
			
			var url = '?quantity=' + $('input[name="quantity"]').val() + '&selected=' + code;
			
			$("#result").load(url, function() {
				changeColor();
				
				var inputCode = $('input[name="code"]');
				var selector = $('select[name="codeSelected"]');
				
				if(!isSelectCode) {
					selector.css('visibility', 'hidden');
				}
				
				var type = $('input[name="type"]').val();
				$('[id="modal-title"]').text(code + ' - ' + type);
			});
		}
		
		$('#myModal').on('show.bs.modal', function(e) {

		    //get data-code/type attribute of the clicked element
		    var code = $(e.relatedTarget).data('code');
		    var type = $(e.relatedTarget).data('type');
		    
		    $('select[name="codeSelected"]').css('visibility', (code == '')? 'visible' : 'hidden');
		    
		    $('input[name="isOwned"]').val(code != '');
		    
		    //populate the textbox
		    $('input[name="code"]').val(code);
		    $('input[name="type"]').val(type);
		    $('input[type="submit"]').val(type);
		    
		    $('[id="modal-title"]').text(code + ' - ' + type);
		    
		    //adapt order button to either 'BUY' or 'SELL' css class 
		    var typeClasses = $(e.relatedTarget).attr("class");
		    $('[id="submitBtn"]').removeClass();
		    $('[id="submitBtn"]').addClass(typeClasses);
		    
		    $("input[name='quantity']").val(0);
		    
		    getData();	
		});
		
		$("input[name='quantity']").TouchSpin({
            min: 0,
            max: 999999999,
            step: 1,
            boostat: 5,
            maxboostedstep: 10
        });
		// ]]>
	</script>
</body>
</html>